{% extends "base.html" %}

{% block title %}Profile - {{ current_user.username }}{% endblock %}

{% block content %}
<div style="text-align: center; margin-bottom: 3rem;">
    <div style="background: var(--accent-primary); color: var(--bg-primary); width: 100px; height: 100px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 2.5rem; margin-bottom: 1rem;">
        {{ current_user.username[0].upper() }}
    </div>
    <h1 style="color: var(--text-primary); margin-bottom: 0.5rem;">{{ current_user.username }}</h1>
    <p style="color: var(--text-secondary);">Member since {{ current_user.created_at.strftime('%B %Y') if current_user.created_at else 'Recently' }}</p>
</div>

<!-- Overall Statistics -->
{% if user_stats %}
<div class="stats-grid">
    <div class="stat-card">
        <span class="stat-value">{{ user_stats.total_speeches or 0 }}</span>
        <span class="stat-label">Total Speeches</span>
    </div>
    <div class="stat-card">
        <span class="stat-value">{{ user_stats.best_level_completed or 0 }}</span>
        <span class="stat-label">Highest Level</span>
    </div>
    <div class="stat-card">
        <span class="stat-value">{{ "%.1f"|format(user_stats.avg_flow_score or 0) }}%</span>
        <span class="stat-label">Avg Flow Score</span>
    </div>
    <div class="stat-card">
        <span class="stat-value">{{ "%.1f"|format(user_stats.avg_repetition_score or 0) }}%</span>
        <span class="stat-label">Avg Clarity</span>
    </div>
    <div class="stat-card">
        <span class="stat-value">{{ "%.1f"|format(user_stats.avg_filler_count or 0) }}</span>
        <span class="stat-label">Avg Fillers</span>
    </div>
    <div class="stat-card">
        <span class="stat-value">{{ user_stats.last_activity.strftime('%m/%d') if user_stats.last_activity else 'Never' }}</span>
        <span class="stat-label">Last Practice</span>
    </div>
</div>
{% endif %}

<!-- Progress Overview -->
<div class="grid grid-2" style="margin-bottom: 3rem;">
    <div class="card">
        <h3 class="card-title">
            <i class="fas fa-trophy" style="color: var(--accent-primary);"></i>
            Level Progress
        </h3>
        <div style="margin-top: 1.5rem;">
            {% for level in levels_progress %}
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
                <div>
                    <strong style="color: var(--text-primary);">Level {{ level.level_number }}: {{ level.title }}</strong>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">{{ level.difficulty.title() }} difficulty</div>
                </div>
                <div style="text-align: right;">
                    {% if level.is_completed %}
                        <span style="color: var(--accent-primary); font-weight: bold;">
                            <i class="fas fa-check-circle"></i> {{ level.score or 0 }}%
                        </span>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">
                            {{ level.completed_at.strftime('%m/%d/%y') if level.completed_at else 'Completed' }}
                        </div>
                    {% else %}
                        <span style="color: var(--text-secondary);">
                            <i class="fas fa-circle"></i> Not Started
                        </span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="card">
        <h3 class="card-title">
            <i class="fas fa-chart-line" style="color: var(--accent-primary);"></i>
            Performance Insights
        </h3>
        {% if user_stats and user_stats.total_speeches > 0 %}
        <div style="margin-top: 1.5rem;">
            <div class="metric-item" style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: var(--text-secondary);">Speaking Confidence</span>
                    <span style="color: var(--accent-primary); font-weight: bold;">
                        {% set confidence = ((user_stats.avg_flow_score or 0) + (user_stats.avg_repetition_score or 0)) / 2 %}
                        {{ "%.0f"|format(confidence) }}%
                    </span>
                </div>
                <div style="background: var(--bg-tertiary); height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: var(--accent-primary); height: 100%; width: {{ confidence }}%; transition: width 0.3s ease;"></div>
                </div>
            </div>

            <div class="metric-item" style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: var(--text-secondary);">Filler Control</span>
                    {% set filler_score = max(0, 100 - (user_stats.avg_filler_count or 0) * 10) %}
                    <span style="color: var(--accent-primary); font-weight: bold;">{{ "%.0f"|format(filler_score) }}%</span>
                </div>
                <div style="background: var(--bg-tertiary); height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: var(--accent-primary); height: 100%; width: {{ filler_score }}%; transition: width 0.3s ease;"></div>
                </div>
            </div>

            <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-tertiary); border-radius: var(--radius);">
                <h5 style="color: var(--accent-primary); margin-bottom: 0.5rem;">Next Goal</h5>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0;">
                    {% if user_stats.best_level_completed < 5 %}
                        Complete Level {{ user_stats.best_level_completed + 1 }} to continue your journey!
                    {% elif user_stats.avg_filler_count > 3 %}
                        Focus on reducing filler words in your speech.
                    {% elif user_stats.avg_flow_score < 80 %}
                        Work on improving your speech flow and structure.
                    {% else %}
                        You're doing great! Keep practicing to maintain your skills.
                    {% endif %}
                </p>
            </div>
        </div>
        {% else %}
        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
            <i class="fas fa-chart-line" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <p>Start practicing to see your performance insights!</p>
            <a href="{{ url_for('quick_task') }}" class="btn btn-primary" style="margin-top: 1rem;">
                <i class="fas fa-play"></i> Start Speaking
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Speech History -->
<div class="card">
    <h3 class="card-title">
        <i class="fas fa-history" style="color: var(--accent-primary);"></i>
        Recent Speech History
    </h3>
    
    {% if speech_history %}
    <div style="margin-top: 1.5rem;">
        {% for speech in speech_history %}
        <div class="speech-record" style="padding: 1rem; border: 1px solid var(--border-color); border-radius: var(--radius); margin-bottom: 1rem; background: var(--bg-tertiary);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <div>
                    <strong style="color: var(--text-primary);">
                        {% if speech.is_quick_task %}
                            <i class="fas fa-bolt"></i> Quick Task
                        {% else %}
                            <i class="fas fa-layer-group"></i> Level {{ speech.level_number }}
                        {% endif %}
                    </strong>
                    {% if speech.level_title and not speech.is_quick_task %}
                        <span style="color: var(--text-secondary);"> - {{ speech.level_title }}</span>
                    {% endif %}
                </div>
                <small style="color: var(--text-secondary);">
                    {{ speech.created_at.strftime('%m/%d/%y at %I:%M %p') if speech.created_at else 'Recently' }}
                </small>
            </div>

            {% if speech.prompt %}
            <p style="color: var(--text-secondary); font-style: italic; margin-bottom: 1rem; font-size: 0.9rem;">
                "{{ speech.prompt }}"
            </p>
            {% endif %}

            {% if speech.ai_feedback %}
            <div class="metrics-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                <div style="text-align: center;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: var(--accent-primary);">
                        {{ speech.ai_feedback.flow_score or 0 }}%
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Flow</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: var(--accent-primary);">
                        {{ speech.ai_feedback.confidence_score or 0 }}%
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Confidence</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: var(--accent-primary);">
                        {{ speech.ai_feedback.filler_count or 0 }}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Fillers</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: var(--accent-primary);">
                        {{ "%.1f"|format(speech.audio_duration or 0) }}s
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Duration</div>
                </div>
            </div>
            {% endif %}

            <!-- Expandable transcription -->
            <button class="toggle-transcription btn btn-secondary" style="font-size: 0.8rem; padding: 0.5rem 1rem;" onclick="toggleTranscription(this)">
                <i class="fas fa-chevron-down"></i> View Transcription
            </button>
            <div class="transcription-content" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-primary); border-radius: var(--radius); border-left: 4px solid var(--accent-primary);">
                <p style="color: var(--text-primary); margin: 0; line-height: 1.6;">
                    "{{ speech.transcription or 'Transcription not available' }}"
                </p>
            </div>
        </div>
        {% endfor %}
        
        {% if speech_history|length >= 20 %}
        <div style="text-align: center; margin-top: 1rem;">
            <p style="color: var(--text-secondary); font-size: 0.9rem;">
                Showing your 20 most recent speeches
            </p>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
        <i class="fas fa-microphone-slash" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
        <p>No speech history yet. Start practicing to build your record!</p>
        <div style="margin-top: 1.5rem;">
            <a href="{{ url_for('quick_task') }}" class="btn btn-primary">
                <i class="fas fa-bolt"></i> Quick Practice
            </a>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-layer-group"></i> Choose Level
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Action Buttons -->
<div style="text-align: center; margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
        <a href="{{ url_for('quick_task') }}" class="btn btn-primary">
            <i class="fas fa-bolt"></i> Quick Practice
        </a>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-home"></i> Dashboard
        </a>
        {% if user_stats and user_stats.best_level_completed < 5 %}
        <a href="{{ url_for('level_page', level_number=user_stats.best_level_completed + 1) }}" class="btn btn-secondary">
            <i class="fas fa-play"></i> Continue Learning
        </a>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleTranscription(button) {
    const content = button.nextElementSibling;
    const icon = button.querySelector('i');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.className = 'fas fa-chevron-up';
        button.innerHTML = '<i class="fas fa-chevron-up"></i> Hide Transcription';
    } else {
        content.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
        button.innerHTML = '<i class="fas fa-chevron-down"></i> View Transcription';
    }
}

// Add smooth animations for progress bars
document.addEventListener('DOMContentLoaded', () => {
    const progressBars = document.querySelectorAll('[style*="width:"]');
    progressBars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.width = width;
        }, 500);
    });
});
</script>
{% endblock %}